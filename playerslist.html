<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Players List - Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-md relative">
    <div class="max-w-7xl mx-auto px-4 py-3 relative flex items-center justify-center">
      <p onclick="window.location.href='admin.html'" class="absolute left-4 text-gray-700 cursor-pointer">
        <i class="fas fa-arrow-left text-2xl"></i>
      </p>
      <h1 class="text-xl font-bold text-gray-800">Players List</h1>
    </div>
  </header>

  <!-- Main -->
  <main class="p-4 md:p-6 space-y-6 overflow-auto flex-grow">
    <!-- Players List Section -->
    <div class="bg-white shadow rounded p-4">
      <div class="flex justify-between items-center mb-4">
        <div class="text-xl font-semibold text-blue-700">Players List</div>
        <div class="flex space-x-2">
          <button id="allPlayerBtn" class="px-4 py-1.5 rounded bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">All Player</button>
          <button id="tourPlayerBtn" class="px-4 py-1.5 rounded bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300">Tour Player</button>
        </div>
      </div>
      <div id="playersCardContainer" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        <!-- Player cards will be inserted here -->
        <div class="col-span-full text-center text-gray-500" id="loadingText">Loading players...</div>
      </div>
    </div>
  </main>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDooTNeDHoWUU9nLxYxyBIhewydt7Xl_M0",
      authDomain: "dlstournament-31ac1.firebaseapp.com",
      projectId: "dlstournament-31ac1",
      storageBucket: "dlstournament-31ac1.appspot.com",
      messagingSenderId: "874377019055",
      appId: "1:874377019055:web:6e38db2ec7f0d541d2de5a",
      measurementId: "G-0DGFJEV6GL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentFilter = "all"; // default all player

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadPlayers();
      }
    });

    // Button actions
    document.getElementById("allPlayerBtn").addEventListener("click", () => {
      currentFilter = "all";
      toggleActiveButton("allPlayerBtn");
      loadPlayers();
    });

    document.getElementById("tourPlayerBtn").addEventListener("click", () => {
      currentFilter = "tour";
      toggleActiveButton("tourPlayerBtn");
      loadPlayers();
    });

    function toggleActiveButton(activeId) {
      const allBtn = document.getElementById("allPlayerBtn");
      const tourBtn = document.getElementById("tourPlayerBtn");

      if (activeId === "allPlayerBtn") {
        allBtn.className = "px-4 py-1.5 rounded bg-blue-600 text-white text-sm font-medium hover:bg-blue-700";
        tourBtn.className = "px-4 py-1.5 rounded bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300";
      } else {
        tourBtn.className = "px-4 py-1.5 rounded bg-blue-600 text-white text-sm font-medium hover:bg-blue-700";
        allBtn.className = "px-4 py-1.5 rounded bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300";
      }
    }

    async function loadPlayers() {
      const container = document.getElementById("playersCardContainer");
      container.innerHTML = `<div class="col-span-full text-center text-gray-500">Loading players...</div>`;

      try {
        let q;
        if (currentFilter === "tour") {
          // Show only players with type === "paid"
          q = query(collection(db, "playersform"), where("type", "==", "paid"));
        } else {
          q = collection(db, "playersform");
        }

        const playersSnapshot = await getDocs(q);

        if (playersSnapshot.empty) {
          container.innerHTML = `<div class="col-span-full text-center text-gray-500">No players found.</div>`;
          return;
        }

        container.innerHTML = "";

        playersSnapshot.forEach(docSnap => {
          const p = docSnap.data();
          const docId = docSnap.id;

          const card = document.createElement("div");
          card.className = "bg-white shadow-md rounded-lg p-4 border border-gray-200";

          const imageUrl = p.photoUrl || "https://via.placeholder.com/80?text=No+Image";

          const imageId = `img-${docId}`;
          const fileInputId = `file-${docId}`;
          const photoUrlInputId = `photourl-${docId}`;
          const updateBtnId = `update-${docId}`;

          card.innerHTML = `
            <div class="flex items-center mb-3">
              <img id="${imageId}" src="${imageUrl}" class="w-10 h-10 rounded-full object-cover border border-gray-300 mr-3" />
              <div>
                <div class="text-lg font-bold text-gray-800">${p.username || "N/A"}</div>
                <div class="text-xs mt-1 inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                  ${p.type || "N/A"}
                </div>
              </div>
              <input type="file" id="${fileInputId}" class="hidden" accept="image/*" />
              <button id="${updateBtnId}" class="ml-auto text-sm text-green-600 hover:underline">Update</button>
            </div>

            <input type="text" id="${photoUrlInputId}" value="${imageUrl}" class="w-full text-xs text-gray-700 mb-3 border rounded px-2 py-1 bg-white" />

            <div class="flex justify-between text-sm text-gray-600 mb-2">
              <div><span class="font-semibold">Team:</span> ${p.team || "N/A"}</div>
              <div><span class="font-semibold">DLS Rating:</span> ${p.dlsRating ?? "N/A"}</div>
            </div>

            <div class="flex justify-between text-sm text-gray-600">
              <div><span class="font-semibold">Age:</span> ${p.age ?? "N/A"} Years</div>
              <div><span class="font-semibold">Played:</span> ${p.yearsPlayed ?? "N/A"} Years</div>
            </div>
          `;

          container.appendChild(card);

          // Handle direct photoUrl update
          const updateBtn = card.querySelector(`#${updateBtnId}`);
          const photoUrlInput = card.querySelector(`#${photoUrlInputId}`);
          const imageEl = card.querySelector(`#${imageId}`);

          updateBtn.addEventListener("click", async () => {
            const newUrl = photoUrlInput.value.trim();
            if (!newUrl) return alert("Photo URL cannot be empty.");

            try {
              await updateDoc(doc(db, "playersform", docId), { photoUrl: newUrl });
              imageEl.src = newUrl;
              alert("Photo URL updated successfully!");
            } catch (err) {
              console.error("Photo URL update error:", err);
              alert("Failed to update photo URL.");
            }
          });

          // File upload logic
          const fileInput = card.querySelector(`#${fileInputId}`);
          updateBtn.addEventListener("dblclick", () => fileInput.click()); 

          fileInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
              const storageRef = ref(storage, `players/${docId}/photo.jpg`);
              await uploadBytes(storageRef, file);
              const downloadURL = await getDownloadURL(storageRef);

              await updateDoc(doc(db, "playersform", docId), { photoUrl: downloadURL });

              imageEl.src = downloadURL;
              photoUrlInput.value = downloadURL;

              alert("Photo uploaded and updated successfully!");
            } catch (err) {
              console.error("Photo upload error:", err);
              alert("Failed to upload photo.");
            }
          });
        });

      } catch (error) {
        console.error("Error loading players:", error);
        container.innerHTML = `<div class="col-span-full text-center text-red-600">${error.message}</div>`;
      }
    }
  </script>

</body>
</html>
