<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col lg:flex-row">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 bg-blue-800 text-white min-h-screen p-5 space-y-6 fixed lg:static top-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-200 z-50 shadow-lg">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-bold">Admin Panel</h2>
      <button id="closeSidebar" class="lg:hidden text-white text-2xl">
        <i class="fas fa-xmark"></i>
      </button>
    </div>
    <nav class="flex flex-col space-y-4 text-sm">
      <a href="admin.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-home"></i><span>Dashboard</span>
      </a>
      <a href="playerslist.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Players List</span>
      </a>
      <a href="fixerslist.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Fixers</span>
      </a>
      <a href="sami.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Sami Fxers</span>
      </a>
      <a href="result-update.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Match Result Update</span>
      </a>
      <a href="point.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Points Table</span>
      </a>
      <a href="livematch.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Live Match</span>
      <a href="finisheddmatch.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Finished Match</span>
      </a>
      <a href="deposit-requests.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Deposit Request</span>
      </a>
      <a href="withdraw-requests.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Withdrawal Request</span>
      </a>
      <a href="referral-setting.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Referral Settings</span>
      </a>
      <a href="setting.html" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition">
        <i class="fas fa-clipboard-list"></i><span>Settings</span>
      </a>
      <button id="logoutBtn" class="flex items-center space-x-3 hover:bg-red-600 p-2 rounded mt-10 transition">
        <i class="fas fa-sign-out-alt"></i><span>Logout</span>
      </button>
    </nav>
  </aside>


  <!-- Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden lg:hidden"></div>

  <!-- Main Content -->
  <div class="flex-grow w-full lg:ml-64 min-h-screen flex flex-col">
    <header class="bg-blue-700 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-30">
      <div class="flex items-center space-x-4">
        <button id="openSidebar" class="lg:hidden text-2xl">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="text-xl font-bold">Admin Panel</h1>
      </div>
    </header>

    <main class="p-4 md:p-6 space-y-6 overflow-auto flex-grow">
      <div class="bg-white shadow rounded p-4">
        <div class="text-xl font-semibold text-blue-700 mb-2" id="totalUsersCount">Total Users: ...</div>
      </div>

      <div class="bg-white shadow rounded p-4" id="usersContainer">
        <div class="mb-4" id="searchInputContainer">
          <input id="searchInput" type="text" placeholder="Search by User ID" class="w-full p-2 border rounded" />
        </div>

        <div id="usersTableBody" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          <div class="text-center text-gray-500 col-span-full">Loading users...</div>
        </div>

        <div id="inlineEditForm" class="hidden mt-6 max-w-xs mx-auto bg-white p-3 rounded shadow text-sm">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold">Edit User</h2>
            <button id="cancelEditBtn" class="text-gray-500 hover:text-black px-1 py-0.5 rounded text-lg">
              <i class="fas fa-xmark"></i>
            </button>
          </div>
          <div class="space-y-3">
            <div>
              <label for="editUserId" class="block text-xs font-medium text-gray-700 mb-1">User ID</label>
              <input id="editUserId" type="text" placeholder="User ID" class="w-full p-1 border rounded text-sm" />
            </div>
            <div>
              <label for="editBalance" class="block text-xs font-medium text-gray-700 mb-1">Balance</label>
              <input id="editBalance" type="number" placeholder="Balance" class="w-full p-1 border rounded text-sm" />
            </div>
            <div>
              <label for="editPhotoUrl" class="block text-xs font-medium text-gray-700 mb-1">Photo URL</label>
              <input id="editPhotoUrl" type="text" placeholder="Photo URL" class="w-full p-1 border rounded text-sm" />
            </div>
            <div>
              <label for="editPassword" class="block text-xs font-medium text-gray-700 mb-1">Password</label>
              <input id="editPassword" type="text" placeholder="Password" class="w-full p-1 border rounded text-sm" />
            </div>
            <div class="flex justify-center">
              <button id="saveEditBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Update</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase and Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDooTNeDHoWUU9nLxYxyBIhewydt7Xl_M0",
      authDomain: "dlstournament-31ac1.firebaseapp.com",
      projectId: "dlstournament-31ac1",
      storageBucket: "dlstournament-31ac1.appspot.com",
      messagingSenderId: "874377019055",
      appId: "1:874377019055:web:6e38db2ec7f0d541d2de5a",
      measurementId: "G-0DGFJEV6GL"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const usersTableBody = document.getElementById("usersTableBody");
    const logoutBtn = document.getElementById("logoutBtn");
    const totalUsersCountElem = document.getElementById("totalUsersCount");

    const inlineEditForm = document.getElementById("inlineEditForm");
    const editUserIdInput = document.getElementById("editUserId");
    const editBalanceInput = document.getElementById("editBalance");
    const editPhotoUrlInput = document.getElementById("editPhotoUrl");
    const editPasswordInput = document.getElementById("editPassword");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveEditBtn = document.getElementById("saveEditBtn");

    const searchInput = document.getElementById("searchInput");
    const searchInputContainer = document.getElementById("searchInputContainer");

    let allUsers = [];
    let currentEditUserDocId = "";

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadTotalUsersCount();
        loadUsers();
      }
    });

    async function loadTotalUsersCount() {
      try {
        const usersCol = collection(db, "users");
        const usersSnapshot = await getDocs(usersCol);
        totalUsersCountElem.textContent = `Total Users: ${usersSnapshot.size}`;
      } catch (err) {
        totalUsersCountElem.textContent = "Total Users: Error";
        console.error("Error loading user count:", err);
      }
    }

    async function loadUsers() {
      try {
        const usersCol = collection(db, "users");
        const usersSnapshot = await getDocs(usersCol);

        if (usersSnapshot.empty) {
          usersTableBody.innerHTML = `<div class="col-span-full text-center p-4 text-gray-500">No users found.</div>`;
          return;
        }

        allUsers = [];
        usersSnapshot.forEach((docSnap) => {
          const user = docSnap.data();
          allUsers.push({ docId: docSnap.id, ...user });
        });

        renderUsers(allUsers);
      } catch (error) {
        usersTableBody.innerHTML = `<div class="col-span-full text-center p-4 text-red-600">Error loading users: ${error.message}</div>`;
        console.error("Error loading users:", error);
      }
    }

    function renderUsers(users) {
      let cardsHtml = "";

      if (users.length === 0) {
        usersTableBody.innerHTML = `<div class="col-span-full text-center p-4 text-gray-500">No users match your search.</div>`;
        return;
      }

      users.forEach((user, index) => {
        const passwordId = `password-${index}`;
        const eyeId = `eye-${index}`;

        cardsHtml += `
          <div class="bg-gray-50 border border-gray-200 rounded-lg shadow p-4 flex flex-col space-y-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <img src="${user.photoUrl || 'https://via.placeholder.com/50'}" alt="Profile" class="rounded-full w-12 h-12 object-cover border" />
                <div>
                  <p class="text-sm text-gray-800 font-semibold">${user.username || "N/A"}</p>
                  <p class="text-xs text-gray-500 break-words max-w-[150px]">${user.email || "N/A"}</p>
                  <p class="text-xs text-gray-400">
                    Password: <span id="${passwordId}">******</span>
                    <i id="${eyeId}" class="fa-solid fa-eye cursor-pointer ml-2 text-blue-500 hover:text-blue-700"></i>
                  </p>
                </div>
              </div>
              <button class="text-blue-600 hover:text-blue-800 editUserBtn"
                      data-docid="${user.docId}"
                      data-userid="${user.userId}"
                      data-balance="${user.balance}"
                      data-photourl="${user.photoUrl}"
                      data-password="${user.password}">
                <i class="fas fa-pen"></i>
              </button>
            </div>
            <div class="flex justify-between text-sm text-gray-700">
              <p><strong>User ID:</strong> ${user.userId || "N/A"}</p>
              <p><strong>Balance:</strong> ৳${user.balance != null ? Number(user.balance).toFixed(0) : "0"}</p>
            </div>
          </div>
        `;
      });

      usersTableBody.innerHTML = cardsHtml;

      users.forEach((user, index) => {
        const passwordId = `password-${index}`;
        const eyeId = `eye-${index}`;
        const eyeIcon = document.getElementById(eyeId);
        const passwordSpan = document.getElementById(passwordId);
        let showing = false;

        eyeIcon.addEventListener("click", () => {
          showing = !showing;
          passwordSpan.textContent = showing ? user.password || "No password" : "******";
          eyeIcon.classList.toggle("fa-eye-slash", showing);
          eyeIcon.classList.toggle("fa-eye", !showing);
        });
      });

      document.querySelectorAll(".editUserBtn").forEach(button => {
        button.addEventListener("click", () => {
          currentEditUserDocId = button.dataset.docid;
          editUserIdInput.value = button.dataset.userid || "";
          editBalanceInput.value = button.dataset.balance || "0";
          editPhotoUrlInput.value = button.dataset.photourl || "";
          editPasswordInput.value = button.dataset.password || "";

          usersTableBody.classList.add("hidden");
          inlineEditForm.classList.remove("hidden");
          searchInputContainer.classList.add("hidden");
        });
      });
    }

    cancelEditBtn.addEventListener("click", () => {
      inlineEditForm.classList.add("hidden");
      usersTableBody.classList.remove("hidden");
      searchInput.value = "";
      searchInputContainer.classList.remove("hidden");
      currentEditUserDocId = "";
      renderUsers(allUsers);
    });

    saveEditBtn.addEventListener("click", async () => {
      const updatedUserId = editUserIdInput.value.trim();
      const updatedBalance = parseFloat(editBalanceInput.value);
      const updatedPhotoUrl = editPhotoUrlInput.value.trim();
      const updatedPassword = editPasswordInput.value.trim();

      if (!currentEditUserDocId || isNaN(updatedBalance)) {
        alert("Invalid input.");
        return;
      }

      try {
        const userDocRef = doc(db, "users", currentEditUserDocId);
        await updateDoc(userDocRef, {
          userId: updatedUserId,
          balance: updatedBalance,
          photoUrl: updatedPhotoUrl,
          password: updatedPassword
        });

        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'success',
          title: 'Update Successful',
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true
        });

        inlineEditForm.classList.add("hidden");
        usersTableBody.classList.remove("hidden");
        searchInput.value = "";
        searchInputContainer.classList.remove("hidden");
        loadUsers();
      } catch (err) {
        alert("Failed to update user.");
        console.error(err);
      }
    });

    searchInput.addEventListener("input", () => {
      const query = searchInput.value.trim().toLowerCase();
      const filtered = allUsers.filter(user =>
        user.userId?.toLowerCase().includes(query)
      );
      renderUsers(filtered);
    });

    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const openSidebarBtn = document.getElementById("openSidebar");
    const closeSidebarBtn = document.getElementById("closeSidebar");

    openSidebarBtn.addEventListener("click", () => {
      sidebar.classList.remove("-translate-x-full");
      overlay.classList.remove("hidden");
    });

    closeSidebarBtn.addEventListener("click", () => {
      sidebar.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
    });
  </script>
</body>
</html>
