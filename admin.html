<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex flex-col lg:flex-row">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 bg-blue-800 text-white min-h-screen p-5 space-y-6 fixed lg:static top-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-200 z-50 shadow-lg">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-bold">Admin Panel</h2>
      <button id="closeSidebar" class="lg:hidden text-white text-2xl">
        <i class="fas fa-xmark"></i>
      </button>
    </div>
    <nav class="flex flex-col space-y-4 text-sm">
      <button id="logoutBtn" class="flex items-center space-x-3 hover:bg-red-600 p-2 rounded mt-10 transition">
        <i class="fas fa-sign-out-alt"></i><span>Logout</span>
      </button>
    </nav>
  </aside>

  <!-- Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden lg:hidden"></div>

  <!-- Main Content -->
  <div class="flex-grow w-full lg:ml-64 min-h-screen flex flex-col">
    <header class="bg-blue-700 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-30">
      <div class="flex items-center space-x-4">
        <button id="openSidebar" class="lg:hidden text-2xl">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="text-xl font-bold">Admin Panel</h1>
      </div>
    </header>

    <main class="p-4 md:p-6 space-y-6 overflow-auto flex-grow">
      <div class="bg-white shadow rounded p-4">
        <div class="text-xl font-semibold text-blue-700 mb-2" id="totalUsersCount">Total Users: ...</div>
      </div>

      <div class="bg-white shadow rounded p-4" id="usersContainer">
        <div id="usersTableBody" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          <div class="text-center text-gray-500 col-span-full">Loading users...</div>
        </div>

        <!-- Inline Edit Form -->
        <div id="inlineEditForm" class="hidden">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold">Edit User</h2>
            <button id="cancelEditBtn" class="text-gray-500 hover:text-black px-2 py-1 rounded">
              <i class="fas fa-xmark text-xl"></i>
            </button>
          </div>
          <div class="space-y-4">
            <input id="editUserId" type="text" placeholder="User ID" class="w-full p-2 border rounded" />
            <input id="editBalance" type="number" placeholder="Balance" class="w-full p-2 border rounded" />
            <input id="editPassword" type="text" placeholder="Password" class="w-full p-2 border rounded" />
            <input id="editPhotoUrl" type="url" placeholder="Photo URL" class="w-full p-2 border rounded" />
            <div class="flex justify-center">
              <button id="saveEditBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Update</button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Firebase and Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDooTNeDHoWUU9nLxYxyBIhewydt7Xl_M0",
      authDomain: "dlstournament-31ac1.firebaseapp.com",
      projectId: "dlstournament-31ac1",
      storageBucket: "dlstournament-31ac1.appspot.com",
      messagingSenderId: "874377019055",
      appId: "1:874377019055:web:6e38db2ec7f0d541d2de5a",
      measurementId: "G-0DGFJEV6GL"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const usersTableBody = document.getElementById("usersTableBody");
    const logoutBtn = document.getElementById("logoutBtn");
    const totalUsersCountElem = document.getElementById("totalUsersCount");

    const inlineEditForm = document.getElementById("inlineEditForm");
    const editUserIdInput = document.getElementById("editUserId");
    const editBalanceInput = document.getElementById("editBalance");
    const editPasswordInput = document.getElementById("editPassword");
    const editPhotoUrlInput = document.getElementById("editPhotoUrl");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveEditBtn = document.getElementById("saveEditBtn");

    let currentEditUserDocId = "";

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadTotalUsersCount();
        loadUsers();
      }
    });

    async function loadTotalUsersCount() {
      try {
        const usersCol = collection(db, "users");
        const usersSnapshot = await getDocs(usersCol);
        totalUsersCountElem.textContent = `Total Users: ${usersSnapshot.size}`;
      } catch (err) {
        totalUsersCountElem.textContent = "Total Users: Error";
        console.error("Error loading user count:", err);
      }
    }

    async function loadUsers() {
      try {
        const usersCol = collection(db, "users");
        const usersSnapshot = await getDocs(usersCol);

        if (usersSnapshot.empty) {
          usersTableBody.innerHTML = `<div class="col-span-full text-center p-4 text-gray-500">No users found.</div>`;
          return;
        }

        const users = [];
        usersSnapshot.forEach((docSnap) => {
          const user = docSnap.data();
          users.push({ docId: docSnap.id, ...user });
        });

        let cardsHtml = "";
        users.forEach((user) => {
          cardsHtml += `
            <div class="bg-gray-50 border border-gray-200 rounded-lg shadow p-4 flex flex-col space-y-3">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <img src="${user.photoUrl || 'https://via.placeholder.com/50'}" alt="Profile" class="rounded-full w-12 h-12 object-cover border" />
                  <div>
                    <p class="text-sm text-gray-800 font-semibold">${user.username || "N/A"}</p>
                    <p class="text-xs text-gray-500 break-words max-w-[150px]">${user.email || "N/A"}</p>
                  </div>
                </div>
                <button class="text-blue-600 hover:text-blue-800 editUserBtn"
                  data-docid="${user.docId}"
                  data-userid="${user.userId || ''}"
                  data-balance="${user.balance || 0}"
                  data-password="${user.password || ''}"
                  data-photo="${user.photoUrl || ''}">
                  <i class="fas fa-pen"></i>
                </button>
              </div>
              <div class="flex flex-col space-y-1 text-sm text-gray-700">
                <p><strong>User ID:</strong> ${user.userId || "N/A"}</p>
                <p><strong>Balance:</strong> à§³${user.balance != null ? Number(user.balance).toFixed(2) : "0.00"}</p>
                <p><strong>Password:</strong> ${user.password || "N/A"}</p>
                <p><strong>Photo URL:</strong> <a href="${user.photoUrl}" class="text-blue-500 break-all" target="_blank">${user.photoUrl || "N/A"}</a></p>
              </div>
            </div>
          `;
        });

        usersTableBody.innerHTML = cardsHtml;

        document.querySelectorAll(".editUserBtn").forEach(button => {
          button.addEventListener("click", () => {
            currentEditUserDocId = button.dataset.docid;
            editUserIdInput.value = button.dataset.userid || "";
            editBalanceInput.value = button.dataset.balance || "0.00";
            editPasswordInput.value = button.dataset.password || "";
            editPhotoUrlInput.value = button.dataset.photo || "";

            usersTableBody.classList.add("hidden");
            inlineEditForm.classList.remove("hidden");
          });
        });

      } catch (error) {
        usersTableBody.innerHTML = `<div class="col-span-full text-center p-4 text-red-600">Error loading users: ${error.message}</div>`;
        console.error("Error loading users:", error);
      }
    }

    cancelEditBtn.addEventListener("click", () => {
      inlineEditForm.classList.add("hidden");
      usersTableBody.classList.remove("hidden");
      currentEditUserDocId = "";
    });

    saveEditBtn.addEventListener("click", async () => {
      const updatedUserId = editUserIdInput.value.trim();
      const updatedBalance = parseFloat(editBalanceInput.value);
      const updatedPassword = editPasswordInput.value.trim();
      const updatedPhotoUrl = editPhotoUrlInput.value.trim();

      if (!currentEditUserDocId || isNaN(updatedBalance)) {
        alert("Invalid input.");
        return;
      }

      try {
        const userDocRef = doc(db, "users", currentEditUserDocId);
        await updateDoc(userDocRef, {
          userId: updatedUserId,
          balance: updatedBalance,
          password: updatedPassword,
          photoUrl: updatedPhotoUrl
        });
        inlineEditForm.classList.add("hidden");
        usersTableBody.classList.remove("hidden");
        loadUsers();
      } catch (err) {
        alert("Failed to update user.");
        console.error(err);
      }
    });

    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const openSidebarBtn = document.getElementById("openSidebar");
    const closeSidebarBtn = document.getElementById("closeSidebar");

    openSidebarBtn.addEventListener("click", () => {
      sidebar.classList.remove("-translate-x-full");
      overlay.classList.remove("hidden");
    });

    closeSidebarBtn.addEventListener("click", () => {
      sidebar.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
    });
  </script>
</body>
</html>
